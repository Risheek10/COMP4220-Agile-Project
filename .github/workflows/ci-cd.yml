name: Build, Lint, and Publish

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build ywBookStore.sln (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore "ywBookStore.sln"
        shell: pwsh

      # --- NEW STEP: LINTING ---
      # 'dotnet format' checks your code against standard C# style rules.
      # The '--verify-no-changes' flag makes the CI fail if code is messy.
      - name: Verify Code Formatting
        run: |
          dotnet format "ywBookStore.sln" --verify-no-changes --severity warn
        shell: pwsh

      # --- UPDATED STEP: STRICT BUILD ---
      # Added '/p:TreatWarningsAsErrors=true'
      # This forces the build to fail if there are any warnings (e.g., unused variables).
      - name: Build solution (Release)
        run: |
          msbuild "ywBookStore.sln" /m /p:Configuration=Release /p:TreatWarningsAsErrors=true
        shell: pwsh

      # --- OPTIONAL: UNIT TESTS ---
      # If you have test projects, uncomment the lines below:
      # - name: Run Unit Tests
      #   run: dotnet test "ywBookStore.sln" --no-build --verbosity normal
      #   shell: pwsh

      - name: Collect bin\Release outputs and zip them
        run: |
          $workspace = $Env:GITHUB_WORKSPACE
          $publishDir = Join-Path $workspace "artifacts\publish"
          if (Test-Path $publishDir) { Remove-Item $publishDir -Recurse -Force }
          New-Item -ItemType Directory -Path $publishDir -Force | Out-Null

          $releaseDirs = Get-ChildItem -Path $workspace -Recurse -Directory | Where-Object { $_.FullName -match '\\bin\\Release$' }
          
          if ($releaseDirs.Count -eq 0) {
            Write-Host "No bin\\Release folders found."
          } else {
            foreach ($d in $releaseDirs) {
              $rel = $d.FullName.Replace($workspace, '').TrimStart('\')
              $safeName = $rel -replace '[\\/:*?"<>|]','_'
              $dest = Join-Path $publishDir $safeName
              New-Item -ItemType Directory -Path $dest -Force | Out-Null
              Copy-Item -Path (Join-Path $d.FullName '*') -Destination $dest -Recurse -Force
            }
          }

          $zipPath = Join-Path $workspace "artifacts\build-output.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          
          if ((Get-ChildItem -Path $publishDir -Recurse | Measure-Object).Count -gt 0) {
            Compress-Archive -Path (Join-Path $publishDir '*') -DestinationPath $zipPath -Force
            Write-Host "Created $zipPath"
          } else {
            New-Item -Path $workspace\artifacts -ItemType Directory -Force | Out-Null
            New-Item -Path $zipPath -ItemType File -Force | Out-Null
          }
        shell: pwsh

      - name: Upload build artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: ywbookstore-build
          path: artifacts/build-output.zip
